# 要件定義書

## プロジェクト概要
### このアプリでできること
このアプリでは、自宅にある消耗品の在庫を一元管理する機能を提供します。
「キッチン」「リビング」などのカテゴリ別に各アイテムと現在の数量を登録することで、自宅の在庫状況を把握できるようにします。

### ユーザーが得られるメリット
- **買い物の効率化**：　在庫が少ないアイテムが一目でわかり、買い忘れや余計な購入を防ぎます。
- **家計の節約**：　無駄な買い物をなくし、日々の出費を抑えて節約に貢献します。

## 機能要件
### ユーザー認証・データモデル関連
- Firebase Authenticationによるログイン認証
  - 条件
    - フロント側で初回ログイン時に`GET /register_user`を叩くこと(2 回目以降は不要)。
    <!-- TODO: シーケンス図作成　-->
    - ログイン認証の詳しい流れはシーケンス図を要確認。

- データモデルの定義
  - カテゴリについて
    - デフォルトカテゴリ
      - 特定のシステムアカウントに紐づく、予め用意されたカテゴリ。 
      - 全てのユーザーが閲覧可能であるが、一般ユーザーによる編集・削除はできない。 
    - カスタムカテゴリ 
      - 各ユーザーが自身のアカウントに紐づけて作成する、ユーザー固有のカテゴリ。 
      - 作成したユーザー本人のみが、自由に作成・編集・削除することが可能。

  - アイテムについて
    - アイテムは、全て各ユーザーが自身のアカウントに紐づけて作成する。 
    - 作成したユーザー本人のみが、自由に作成・編集・削除することが可能。 
    - アイテムは、デフォルトカテゴリ、または自身のカスタムカテゴリのいずれかに所属する。

### カテゴリ管理機能　<!-- TODO: シーケンス図作成　-->
- カテゴリ一覧の取得
  - 条件
    - デフォルトカテゴリと、ログインユーザーが作成したカスタムカテゴリを合算して取得する。
    - 削除フラグが`false`のレコードのみを対象とする。
    - 辞書順に表示する。
- カテゴリの新規作成（カスタムカテゴリ）
  - 条件
    - カテゴリ名は必須。
    - カテゴリ名は50文字以内。
    - デフォルトカテゴリ及び自身のカスタムカテゴリ内で、カテゴリ名が重複しない。
    - ユーザーが作成できるカスタムカテゴリは50件まで。
- カテゴリの編集（カスタムカテゴリ）
  - 条件
    - 編集対象は、自身が作成したカスタムカテゴリのみとする。
    - カテゴリ名は必須。
    - カテゴリ名は50文字以内。
    - デフォルトカテゴリ及び自身のカスタムカテゴリと、カテゴリ名が重複しない。
- カテゴリの削除
  - 条件
    - 削除対象は、自身が作成したカスタムカテゴリのみとする。
    - カテゴリに紐づくアイテムが存在しない。
    - `categories`テーブルの該当レコードを論理削除。

### アイテム管理機能　<!-- TODO: シーケンス図作成　-->
- 特定のカテゴリに属するアイテム一覧の取得
  - 条件
    - カテゴリIDに紐づくアイテムを取得する。
    - ログインユーザーが作成したアイテムのみを取得する。
    - 削除フラグが`false`のレコードのみを対象とする。
    - 更新日が新しい順に表示する。
- アイテムをカテゴリに紐づけて新規作成
  - 条件
    - アイテム名は必須。
    - アイテム名は50文字以内。
    - 選択したカテゴリ内で、アイテム名が重複しない。
    - カテゴリの選択は必須。
    - 選択できるカテゴリは、デフォルトカテゴリまたは自身が作成したカスタムカテゴリであること。
    - 数量（`quantity`）を指定しない場合はデフォルト値として0を登録。
    - ユーザーが作成できるアイテムはユーザーごとに9999件まで。
- アイテム情報（名前、在庫数）の更新
  - 条件
    - 編集対象は、自身が作成したアイテムのみとする。
    - アイテム名は必須。
    - アイテム名は50文字以内であること。
    選択したカテゴリ内で、アイテム名が重複しない。
    - 数量（`quantity`）が0以上の整数であること。
- アイテムの削除
  - 条件
    - 削除対象は、自身が作成したアイテムのみとする。
    - `items`テーブルの該当レコードを論理削除。

## ユースケース
### 【ユースケース1: カスタムカテゴリを新規作成する】
- **概要：**　ユーザーが自分専用の新しいカテゴリを作成する
- **アクター：**　ユーザー
- **事前条件：**　ユーザーがログインしている
- **成功シナリオ**　
  1. ユーザーは、新しいカテゴリ名を入力し、作成をシステムに要求する。 
  2. システムは、入力されたカテゴリ情報を検証する。（名前：必須・文字数上限(50文字)・重複(デフォルトカテゴリおよび自身のカスタムカテゴリ内)、登録上限数：50件） *1 *2 *3 *4 
  3. システムは、新しいカスタムカテゴリをログインユーザーに紐づけてデータベースに保存する。 
  4. システムは、ユーザーに「カスタムカテゴリの作成が完了しました」と通知する。
- **例外シナリオ**
  - （*1）カテゴリ名が空だった場合
    1. システムは、ユーザーに「カテゴリ名は必須です」というエラーメッセージを表示する。
  - （*2）カテゴリ名が50文字を超えている場合
    1. システムは、ユーザーに「カテゴリ名は50文字以内で入力してください」というエラーメッセージを表示する。
  - （*3）カテゴリ名が重複していた場合
    1. システムは、ユーザーに「そのカテゴリ名は既に使用されています」というエラーメッセージを表示する。
  - （*4）登録カテゴリ数が上限の50件に達している場合
    1. システムは、ユーザーに「登録できるカテゴリの上限に達しています」というエラーメッセージを表示する。

### 【ユースケース2: カテゴリの一覧を表示する】
- **概要：**　ユーザーが、利用可能な全てのカテゴリ（デフォルト＋カスタム）の一覧を確認する。
- **アクター：**　ユーザー
- **事前条件：**　ユーザーがシステムにログインしている。
- **成功シナリオ**　
  1. ユーザーは、カテゴリ一覧の表示をシステムに要求する。
  2. システムは、デフォルトカテゴリ（共通）と、ログイン中のユーザーが作成したカスタムカテゴリを全て取得する。 *1
  3. システムは、取得したカテゴリの一覧をの辞書順に表示する。
- **例外シナリオ**
  - （*1）表示可能なカテゴリが1件もなかった場合（※基本的には発生しない想定）
    1. システムは、「表示可能なカテゴリがありません」というメッセージを表示する。

### 【ユースケース3: カテゴリを編集する】
- **概要：**　ユーザーが自身で作成したカスタムカテゴリの名前を変更する。
- **アクター：**　ユーザー
- **事前条件：**
  - ユーザーがシステムにログインしている。
  - 編集対象のカテゴリが存在し、ログイン中のユーザーが作成したカスタムカテゴリである。
- **成功シナリオ**　
  1. ユーザーは、一覧から編集したいカスタムカテゴリを選択し、新しいカテゴリ名を入力して、更新をシステムに要求する。 *1
  2. システムは、入力されたカテゴリ名を検証する。（必須、文字数上限(50文字)、重複） *2 *3 *4
  3. システムは、データベースの該当するカテゴリ名を更新する。
  4. システムは、ユーザーに「カスタムカテゴリの更新が完了しました」と通知する。
- **例外シナリオ**
  - （*1）編集対象がデフォルトカテゴリだった場合
    1. システムは、ユーザーに「デフォルトカテゴリは編集できません」というエラーメッセージを表示する。
  - （*2）カテゴリ名が空だった場合
    1. システムは、ユーザーに「カテゴリ名は必須です」というエラーメッセージを表示する。
  - （*3）カテゴリ名が50文字を超えている場合
    1. システムは、ユーザーに「カテゴリ名は50文字以内で入力してください」というエラーメッセージを表示する。
  - （*4）カテゴリ名が重複していた場合
    1. システムは、ユーザーに「そのカテゴリ名は既に使用されています」というエラーメッセージを表示する。

### 【ユースケース4: カテゴリを削除する】
- **概要：**　ユーザーが自身で作成したカスタムカテゴリを削除する。
- **アクター：**　ユーザー
- **事前条件：**
  - ユーザーがシステムにログインしている。
  - 削除対象のカテゴリが存在し、ログイン中のユーザーが作成したカスタムカテゴリである。
- **成功シナリオ**　
  1. ユーザーは、削除したいカスタムカテゴリの編集ページを開き、削除をシステムに要求する。 *1
  2. システムは、そのカテゴリにアイテムが含まれていないことを確認する。 *2
  3. システムは、ユーザーに削除の最終確認を求める。
  4. ユーザーは、削除を承認する。 *3
  5. システムは、データベースの該当カテゴリを論理削除する。
  6. システムは、ユーザーに「カスタムカテゴリの削除が完了しました」と通知し、カテゴリ一覧画面に戻る。
- **例外シナリオ**
  - （*1）削除対象がデフォルトカテゴリだった場合
    1. システムは、ユーザーに「デフォルトカテゴリは削除できません」というエラーメッセージを表示する。
  - （*2）カテゴリにアイテムが1件以上含まれている場合
    1. システムは、ユーザーに「アイテムが1件以上登録されているカテゴリは削除できません」というエラーメッセージを表示する。
  - （*3） ユーザーが最終確認でキャンセルした場合
    1. システムは操作を中断し、カテゴリ編集ページに戻る。

### 【ユースケース5: アイテムの一覧を表示する】
- **概要：**　ユーザーが、特定のカテゴリに属する自身が作成したアイテムの一覧を確認する。
- **アクター：**　ユーザー　
- **事前条件：**
  - ユーザーがシステムにログインしている。
  - ユーザーがアイテムの一覧を確認したいカテゴリを選択している。
- **成功シナリオ**　
  1. ユーザーは、アイテム一覧を確認したいカテゴリを選択し、表示をシステムに要求する。
  2. システムは、選択されたカテゴリに紐づく、ログイン中のユーザーが作成したアイテムを全て取得する。 *1
  3. システムは、取得したアイテムの一覧を更新日の新しい順に表示する。
- **例外シナリオ**
  - （*1）表示可能なアイテムが1件もなかった場合
    1. システムは、「アイテムが登録されていません」というメッセージを表示する。

### 【ユースケース6: アイテムを新規作成する】
- **概要：**　ユーザーが、特定のカテゴリに新しいアイテムを追加する。
- **アクター：**　ユーザー　
- **事前条件：**
  - ユーザーがシステムにログインしている。 
  - アイテムを登録するためのカテゴリが1つ以上存在している。
- **成功シナリオ**　
  1. ユーザーは、アイテム名、所属カテゴリ、数量を入力し、作成をシステムに要求する。
  2. システムは、入力内容を検証する。（アイテム名：必須・文字数上限(50文字)・重複、カテゴリ：必須、数量：形式、登録上限数(ユーザーごとに9999件)） *1 *2 *3 *4 *5
  3. システムは、新しいアイテムをログインユーザーに紐付けてデータベースに保存する。（数量が未入力の場合は0として保存）
  4. システムは、ユーザーに「アイテムの作成が完了しました」と通知する。
- **例外シナリオ**
  - （*1）アイテム名、または所属カテゴリが未選択の場合
    1. システムは、ユーザーに「アイテム名とカテゴリは必須です」というエラーメッセージを表示する。
  - （*2）アイテム名が50文字を超えている場合
    1. システムは、ユーザーに「アイテム名は50文字以内で入力してください」というエラーメッセージを表示する。
  - （*3）同一カテゴリ内に同じアイテム名が既に存在する場合
    1. システムは、ユーザーに「そのアイテム名は既に登録されています」というエラーメッセージを表示する。
  - （*4）数量が不正な形式（0未満の整数など）だった場合
    1. システムは、ユーザーに「数量は0以上の整数で入力してください」というエラーメッセージを表示する。
  - （*5）ユーザーの登録アイテム数が上限の9999件に達している場合
    1. システムは、ユーザーに「これ以上アイテムを登録できません」というエラーメッセージを表示する。

### 【ユースケース7: アイテムを編集する】
- **概要：**　ユーザーが、自身で作成したアイテムの名前や数量を変更する。
- **アクター：**　ユーザー　
- **事前条件：**
  - ユーザーがシステムにログインしている。 
  - 編集対象のアイテムが存在し、ログイン中のユーザーが作成したアイテムである。
- **成功シナリオ**　
  1. ユーザーは、一覧から編集したいアイテムを選択し、新しい名前や数量を入力して、更新をシステムに要求する。
  2. システムは、入力内容を検証する。（アイテム名：必須・文字数上限(50文字)・重複、数量：形式） *1 *2 *3 *4
  3. システムは、データベースの該当アイテム情報を更新する。 
  4. システムは、ユーザーに「アイテムの更新が完了しました」と通知する。
- **例外シナリオ**
  - （*1）アイテム名が空だった場合
    1. システムは、ユーザーに「アイテム名は必須です」というエラーメッセージを表示する。
  - （*2）アイテム名が50文字を超えている場合
    1. システムは、ユーザーに「アイテム名は50文字以内で入力してください」というエラーメッセージを表示する。
  - （*3）同一カテゴリ内に同じアイテム名が既に存在する場合
    1. システムは、ユーザーに「そのアイテム名は既に登録されています」というエラーメッセージを表示する。
  - （*4）数量が不正な形式（0未満の整数など）だった場合
    1. システムは、ユーザーに「数量は0以上の整数で入力してください」というエラーメッセージを表示する。

### 【ユースケース8: アイテムを削除する】
- **概要：**　ユーザーが自身で作成した既存のアイテムを削除する。
- **アクター：**　ユーザー　
- **事前条件：**
  - ユーザーがシステムにログインしている。 
  - 削除対象のアイテムが存在し、ログイン中のユーザーが作成したアイテムである。
- **成功シナリオ**　
  1. ユーザーは、アイテム編集ページを開き、削除をシステムに要求する。
  2. システムは、ユーザーに削除の最終確認を求める。
  3. ユーザーは、削除を承認する。 *1
  4. システムは、データベースの該当アイテムを論理削除する。
  5. システムは、ユーザーに「アイテムの削除が完了しました」と通知し、カテゴリ内のアイテム一覧ページに遷移する。
- **例外シナリオ**
  - （*1）ユーザーが最終確認でキャンセルした場合
    1. システムは、操作を中断し、アイテム編集ページに戻る。

## 非機能要件
- GitHub によるプロジェクト管理
- プルリクエストベースの開発フローを採用
- Spring Boot(Java)による REST API の設計・実装
- Swagger による API 仕様書の自動生成
- JUnit、Mockito を用いたユニットテストの作成
- Postman による API の動作確認
- Firebase Authentication による API 認証の実装
- DB は H2 を使用
- ビルドツールは Gradle を使用

## 作業スケジュール（予定）
- 設計書作成（5日間：7/16-18、22-25）
  - 要件定義書
  - ER図
  - API仕様書
  - DTO, Entity定義書
- 環境構築（2日間）
- 実装（3日間）
- テスト（2日間）

## 将来的な実装検討機能（案）
今回の実装の範囲からは対象外とする
- 全般
  - 表記の揺れに対する対応
    - **バックエンド対応**
      - DBのitems, categoriesテーブルにnormalized_nameカラムを追加する。
      - 新規作成・更新時にnameカラムからnormalized_nameカラムを生成し、保存する処理を追加する。
      - サジェスト機能のための新しいAPI (`GET /items/suggestions`) を作成する。
        - API内部では、検索キーワードを正規化し、normalized_nameカラムをLIKE検索する。
    - **フロントエンド対応**
      - 文字入力のたびにバックエンドのサジェストAPIを呼び出す。
      - APIからの返却結果を候補として入力欄の下に表示する。
    - 備考
      - 表記の揺れに対応時に合わせて変更する機能
        - カテゴリ・アイテムともに「nameカラムが同一だと登録できない」条件を外す
          - ユーザーがアイテムを登録しようとした際、バックエンドはnormalized_nameで重複チェックを行うよう変更
          - もし重複が見つかった場合、即座にエラーにはしない。
          - フロントエンドで、「このアイテムと似ていますが、本当に別のアイテムとして新規登録しますか？」という確認ダイアログを表示する。
          - ユーザーが承認した上でnormalized_nameが同じアイテムも登録が可能
  - 家族（グループ）機能
    - 家族でカテゴリ・リストを共有できる
    - アイテムにユーザーを紐付け、誰がこのアイテムを登録したのか確認できるようにする
  - 買い物リスト
    - アイテムテーブルの買い物リストカラムがtrueになっているものを一覧として出力
    - 各アイテムの「購入完了」を実行すると、数量の入力を求められ、入力したものがアイテムの数量に足される
  - アイテムの検索機能
    - カテゴリを横断してアイテムを検索する
      - 正規表現を用いて類似するものも結果として出力する
- カテゴリ情報
  - アイコンの設定
- 中カテゴリの追加
  - 現在のカテゴリを大カテゴリとし、紐づく中カテゴリを追加
  - アイテムは中カテゴリにぶら下がる
- カテゴリ一覧
  - カテゴリの並び替え機能
    - 辞書順（昇順・降順）
    - 手動
- アイテム情報
  - カラムの追加
    - 画像
    - 内容量
    - URL
    - 消費期限
    - 購入場所
    - 購入金額
    - 買い物リスト（boolean）
  - アイテムの履歴
- アイテム一覧
  - 全てのアイテム一覧
    - カテゴリを横断して全てのアイテムを表示する
  - アイテムの並び替え機能
    - 辞書順（昇順・降順）
    - 在庫数順（昇順・降順）
    - 期限順（昇順・降順）　*アイテムに消費期限の設定機能を追加した際
    - 手動
- アイテムの移動
  - カテゴリを跨いでアイテムを移動させる
    - 移動のUI
      - カテゴリ編集の画面に「アイテムの移動」を追加
      - カテゴリ内のアイテムを複数選択できるようにし、「アイテムの移動」でまとめて移動できるようにする
    - 移動時に移動先のカテゴリ内に正規表現で一致するものがあった場合は、同一の物として扱い数量をプラスするのか、別物として扱いアイテムを保存するのか選択する
